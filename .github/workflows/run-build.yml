name: Build and Release Arttulcat

on:
  push:
    branches:
      - main # Automatically trigger on pushes to the 'main' branch
  workflow_dispatch: # Allows manual triggering from GitHub UI

# Grant permissions for the release job to create releases and tags
permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-13, windows-latest] # macos-13 for amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up build environment for Ubuntu
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential curl git mercurial python3 python3-pip zip unzip npm \
            autoconf2.13 libtool libffi-dev libgdk-pixbuf2.0-dev libgtk-3-dev \
            libdbus-1-dev libevent-dev libglib2.0-dev libssl-dev libx11-dev \
            libxcomposite-dev libxdamage-dev libxext-dev libxfixes-dev \
            libxrandr-dev libxtst-dev libxinerama-dev libncursesw5-dev \
            libnotify-dev libasound2-dev libpulse-dev libcairo2-dev libpixman-1-dev yasm \
            wget

      - name: Set up build environment for macOS (amd64)
        if: matrix.os == 'macos-13'
        run: |
          xcode-select --install || true
          brew update
          brew install mercurial git rust openssl@1.1 wget

      # --- START OF WINDOWS MOZILLABUILD .EXE INSTALLER SETUP ---
      - name: Download and Install MozillaBuild via .exe for Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh # Use PowerShell for these Windows-specific commands
        run: |
          Write-Host "Setting up MozillaBuild via .exe installer..."
          $MozBuildDir = "C:\mozilla-build" # Standard installation directory
          
          if (Test-Path $MozBuildDir) {
            Write-Host "MozillaBuild directory already exists at $MozBuildDir. Assuming it's correctly installed."
          } else {
            Write-Host "MozillaBuild not found. Downloading MozillaBuildSetup-Latest.exe..."
            $InstallerUrl = "https://ftp.mozilla.org/pub/mozilla/libraries/win32/MozillaBuildSetup-Latest.exe"
            $InstallerPath = Join-Path $env:TEMP "MozillaBuildSetup-Latest.exe"

            Write-Host "Downloading from $InstallerUrl to $InstallerPath..."
            Invoke-WebRequest -Uri $InstallerUrl -OutFile $InstallerPath -UseBasicParsing
            
            Write-Host "Running MozillaBuild installer silently (using /S switch)..."
            # The /S switch is typically used for silent installation.
            # Start-Process with -Wait ensures the script waits for the installer to finish.
            $process = Start-Process -FilePath $InstallerPath -ArgumentList "/S" -Wait -PassThru
            
            if ($process.ExitCode -ne 0) {
                Write-Error "MozillaBuild installer failed with exit code $($process.ExitCode)."
                # Attempt to clean up downloaded installer
                if (Test-Path $InstallerPath) { Remove-Item $InstallerPath -Force -ErrorAction SilentlyContinue }
                exit 1
            }
            Write-Host "MozillaBuild installer finished."
            
            # Clean up the downloaded installer
            if (Test-Path $InstallerPath) { Remove-Item $InstallerPath -Force -ErrorAction SilentlyContinue }

            # Verify installation directory
            if (-not (Test-Path $MozBuildDir)) {
                Write-Error "MozillaBuild installation directory $MozBuildDir not found after running installer. Installation might have failed silently or installed to a different location."
                exit 1
            }
            Write-Host "MozillaBuild appears to be installed at $MozBuildDir."
          }
          
          # Set the MOZILLABUILD environment variable for the current job.
          echo "MOZILLABUILD=$MozBuildDir" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          Write-Host "MOZILLABUILD environment variable set to '$MozBuildDir' for subsequent steps."
      # --- END OF WINDOWS MOZILLABUILD .EXE INSTALLER SETUP ---

      - name: Set up Git for Windows (Scoop then Chocolatey)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "Attempting to install Git..."
          if (Get-Command scoop -ErrorAction SilentlyContinue) {
            Write-Host "Scoop is available. Attempting to install Git via Scoop."
            scoop install git
            if ($LASTEXITCODE -eq 0) { Write-Host "Git installed successfully via Scoop." }
            else {
              Write-Warning "Scoop install git failed. Attempting with Chocolatey."
              choco install -y git.install --skip-powershell
              if ($LASTEXITCODE -ne 0) { Write-Error "Choco install git also failed."; exit 1 }
              Write-Host "Git installed successfully via Chocolatey."
            }
          } else {
            Write-Host "Scoop not found. Installing Git via Chocolatey."
            choco install -y git.install --skip-powershell
            if ($LASTEXITCODE -ne 0) { Write-Error "Choco install git failed."; exit 1 }
            Write-Host "Git installed successfully via Chocolatey."
          }
          git --version

      - name: Set up Mercurial and other tools for Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "Installing pipx..."
          python -m pip install --user pipx
          if ($LASTEXITCODE -ne 0) { Write-Error "Failed to install pipx."; exit 1 }
          $PipxBinPath = Join-Path $env:USERPROFILE ".local\bin"
          echo "$PipxBinPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$PipxBinPath;" + $env:PATH
          
          Write-Host "Installing Mercurial via pipx..."
          pipx install mercurial
          if ($LASTEXITCODE -ne 0) { Write-Error "pipx install mercurial failed."; exit 1 }
          hg --version

          Write-Host "Installing 7-Zip via Chocolatey..."
          choco install -y 7zip.install
          if ($LASTEXITCODE -ne 0) { Write-Error "choco install 7zip.install failed."; exit 1 }
          $SevenZipPath1 = "C:\Program Files\7-Zip"
          $SevenZipPath2 = "C:\Program Files (x86)\7-Zip"
          if (Test-Path (Join-Path $SevenZipPath1 "7z.exe")) {
            echo "$SevenZipPath1" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } elseif (Test-Path (Join-Path $SevenZipPath2 "7z.exe")) {
            echo "$SevenZipPath2" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

          Write-Host "Installing wget via Chocolatey..."
          choco install -y wget || Write-Warning "choco install wget failed. Continuing..."

      - name: Make build script executable (Linux/macOS)
        if: matrix.os != 'windows-latest'
        run: chmod +x ./build.sh

      - name: Run Arttulcat build script
        shell: bash 
        env:
          MOZILLABUILD: ${{ env.MOZILLABUILD }} 
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "MOZILLABUILD environment variable in bash (Windows): $MOZILLABUILD"
          fi
          ./build.sh

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arttulcat-build-${{ matrix.os }}
          path: ./release_artifacts/

  release:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts 

      - name: List downloaded artifacts (for debugging)
        run: |
          echo "Listing contents of 'artifacts' directory:"
          ls -R artifacts
          echo "---"

      - name: Create release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: Arttulcat Release v${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/arttulcat-build-ubuntu-latest/arttulcat.tar.gz
            artifacts/arttulcat-build-ubuntu-latest/arttulcat*.deb
            artifacts/arttulcat-build-ubuntu-latest/arttulcat*.rpm
            artifacts/arttulcat-build-macos-13/arttulcat.dmg
            artifacts/arttulcat-build-windows-latest/arttulcat.exe
            artifacts/arttulcat-build-windows-latest/arttulcat.zip
